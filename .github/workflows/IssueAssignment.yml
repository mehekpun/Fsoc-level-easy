name: Check User Assignments on PR Open

on:
  pull_request:
    types: [opened]

jobs:
  check-assignments:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    env:
      BACKEND_URL: https://pullquestgithubbackend-1.onrender.com
    
    steps:
    - name: Get PR assignee or author
      id: get_user
      run: |
        # Check if PR has assignees
        assignees='${{ toJson(github.event.pull_request.assignees) }}'
        pr_author="${{ github.event.pull_request.user.login }}"
        
        if [[ "$assignees" != "[]" ]]; then
          # Extract first assignee username
          username=$(echo "$assignees" | jq -r '.[0].login')
          echo "username=$username" >> $GITHUB_OUTPUT
          echo "âœ… Found assignee: $username"
        else
          # Use PR author if no assignee
          echo "username=$pr_author" >> $GITHUB_OUTPUT
          echo "âœ… No assignee found, using PR author: $pr_author"
        fi
    
    - name: Debug â€“ print extracted info
      run: |
        echo "ğŸ” PR Number   : ${{ github.event.pull_request.number }}"
        echo "ğŸ” Username    : ${{ steps.get_user.outputs.username }}"
        echo "ğŸ” Repository  : ${{ github.event.repository.full_name }}"
        echo "ğŸ” Owner       : ${{ github.event.repository.owner.login }}"
        echo "ğŸ” Repo Name   : ${{ github.event.repository.name }}"
    
    - name: Build payload âœ POST to backend
      run: |
        PR_NUMBER=${{ github.event.pull_request.number }}
        USERNAME="${{ steps.get_user.outputs.username }}"
        
        # Assemble payload for assignment check
        payload=$(jq -n \
          --arg owner         "${{ github.event.repository.owner.login }}" \
          --arg repo          "${{ github.event.repository.name }}" \
          --arg assignedUser  "$USERNAME" \
          --argjson issueNumber  "$PR_NUMBER" \
          '{
            owner: $owner,
            repo: $repo, 
            issueNumber: $issueNumber,
            assignedUser: $assignedUser
          }')
        
        echo "ğŸ“¦ Payload:"
        echo "$payload"
        
        response=$(curl --fail --show-error --silent \
          -X POST "$BACKEND_URL/api/hactoberfest/IssueAssigned" \
          -H "Content-Type: application/json" \
          --data-raw "$payload" \
          -w '\nHTTP %{http_code}\n' )
        
        echo "ğŸ” Response: $response"
    
    - name: Done
      run: echo "âœ… Assignment check completed and comment posted to PR"